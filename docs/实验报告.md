# 图片管理网站 — 实验报告

---

## 1. 实验概述

### 1.1 实验目的

本实验旨在设计并实现一个功能完善的图片管理网站，通过实践掌握现代 Web 全栈开发技术，包括前端框架 Vue 3、后端框架 Django、异步任务处理、AI 集成等技术。

### 1.2 实验环境

| 项目 | 配置 |
|------|------|
| 操作系统 | Linux (Ubuntu/WSL2) |
| 前端框架 | Vue 3 + Vite + Element Plus |
| 后端框架 | Django 3.2 + Django REST Framework |
| 数据库 | SQLite 3 |
| 异步任务 | Celery + Redis |
| AI 服务 | SiliconFlow API (deepseek-vl2) |

---

## 2. 功能完成情况

### 2.1 基本功能（11 项）

| 序号 | 功能 |
|------|------|
| 1 | 用户注册/登录（用户名、密码、邮箱验证） |
| 2 | PC/手机浏览器上传图片 |
| 3 | EXIF 自动解析与标签生成 |
| 4 | 自定义标签管理 |
| 5 | 缩略图自动生成 |
| 6 | 数据库持久化存储 |
| 7 | 多条件查询检索 |
| 8 | 友好展示界面（轮播、画廊） |
| 9 | 图片编辑（裁剪、旋转、调色） |
| 10 | 删除功能（单个/批量） |
| 11 | 移动端适配 |


### 2.2 增强功能

| 序号 | 功能 |
|------|------|
| 1 | AI 模型分析图片生成描述 |

---

## 3. 系统架构

### 3.1 整体架构图

```
┌──────────────────────────────────────────────────────────┐
│                     前端 (Vue 3)                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐     │
│  │ Element │  │  Pinia  │  │  Axios  │  │Cropperjs│     │
│  │  Plus   │  │  Store  │  │   API   │  │ Editor  │     │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘     │
└──────────────────────┬───────────────────────────────────┘
                       │ HTTP/REST
┌──────────────────────▼───────────────────────────────────┐
│                   后端 (Django)                          │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐     │
│  │  DRF    │  │ djoser  │  │ Pillow  │  │ExifRead │     │
│  │ ViewSet │  │  Auth   │  │ 图片处理 │  │EXIF解析 │     │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘     │
│                      │                                   │
│  ┌───────────────────▼─────────────────────────────┐    │
│  │              Celery 异步任务                      │    │
│  │  • 缩略图生成  • EXIF 解析  • 自动标签生成        │    │
│  └─────────────────────────────────────────────────┘    │
└──────────────────────┬───────────────────────────────────┘
                       │
         ┌─────────────┼─────────────┐
         ▼             ▼             ▼
    ┌─────────┐  ┌─────────┐  ┌─────────┐
    │ SQLite  │  │  Redis  │  │SiliconFlow│
    │ 数据库  │  │消息队列 │  │  AI API  │
    └─────────┘  └─────────┘  └─────────┘
```

### 3.2 技术栈说明

| 层级 | 技术 | 作用 |
|------|------|------|
| 前端框架 | Vue 3 + Composition API | 构建响应式用户界面 |
| UI 组件 | Element Plus | 提供丰富的 UI 组件 |
| 状态管理 | Pinia | 管理全局状态 |
| HTTP 客户端 | Axios | API 请求封装 |
| 后端框架 | Django + DRF | RESTful API 开发 |
| 用户认证 | djoser | 用户注册、登录、Token 管理 |
| 图片处理 | Pillow | 缩略图生成、图片编辑 |
| EXIF 解析 | ExifRead | 提取图片元数据 |
| 异步任务 | Celery + Redis | 处理耗时操作 |
| AI 服务 | SiliconFlow | 图片描述生成 |

---

## 4. 开发过程中的问题与解决

### 4.1 遇到的部分 Bug

| Bug | 问题描述 | 原因分析 | 解决方案 |
|-----|----------|----------|----------|
| #1 | 头像更换后页面不刷新 | 前端未清除缓存 | 添加页面刷新逻辑 |
| #2 | 网格选择无勾选标记 | 自定义复选框样式问题 | 重写复选框组件样式 |
| #3 | 移动端按钮图标消失 | CSS 样式覆盖 | 使用 el-icon 组件 |
| #4 | AI 生成返回 404 | action 放错 ViewSet | 移动到正确的 ViewSet |
| #5 | 批量操作按钮不显示 | watch 未深度监听 | 添加 `{ deep: true }` |

### 4.2 部分问题分析

#### Bug #4: AI 生成 404 错误

**问题表现**: 点击 AI 生成描述按钮时，API 返回 404 错误。

**原因分析**: Django REST Framework 的 `@action` 装饰器会根据所在 ViewSet 生成 URL。`generate_ai_description` 方法被错误地放在了 `AdminImageViewSet` 中，导致 URL 变成了 `/api/admin/images/{id}/generate_ai_description/`，而前端请求的是 `/api/images/{id}/generate_ai_description/`。

**解决方案**: 将方法移动到 `ImageViewSet` 中。

**经验教训**: DRF 的 action 会根据所在 ViewSet 生成 URL，放错位置会导致 404。

#### Bug #5: 批量操作按钮不显示

**问题表现**: 在网格视图中选择图片后，底部的批量操作按钮没有出现。

**原因分析**: Vue 3 的 `watch` 默认不会深度监听数组的变化（如 push、splice）。

**解决方案**:
```javascript
watch(selectedImageIds, (ids) => {
  selectedImages.value = images.value.filter(img => ids.includes(img.id))
}, { deep: true })  // 添加 deep: true
```

---

## 5. 技术要点

### 5.1 前端技术要点

#### Vue 3 Composition API

相比 Options API 的优势：
- 逻辑复用更灵活，可抽取为 composable 函数
- TypeScript 支持更好
- 相关逻辑可以组织在一起

#### Pinia 状态管理

比 Vuex 更简洁，不需要 mutations：
```javascript
// Pinia - 直接修改
userStore.token = newToken

// Vuex - 需要 mutation
commit('SET_TOKEN', newToken)
```

### 5.2 后端技术要点

#### Celery 异步任务

对于耗时操作使用异步处理：
```python
# 同步处理 - 用户需要等待
process_image(image)  # 可能需要几秒

# 异步处理 - 立即返回
process_image.delay(image.id)  # 毫秒级返回
```

#### API Key 加密存储

使用 Fernet 对称加密：
```python
from cryptography.fernet import Fernet

# 使用 Django SECRET_KEY 派生加密密钥
key = base64.urlsafe_b64encode(hashlib.sha256(SECRET_KEY.encode()).digest())
fernet = Fernet(key)

# 加密存储
encrypted = fernet.encrypt(api_key.encode())
```

---

## 6. 项目亮点

### 6.1 技术亮点

1. **完整的前后端分离架构**: Vue 3 + Django REST Framework
2. **异步任务处理**: Celery + Redis 处理耗时操作，提升用户体验
3. **AI 集成**: 接入视觉大模型生成图片描述
4. **安全设计**: API Key 加密存储、权限控制、文件校验

### 6.2 功能亮点

1. **智能 EXIF 解析**: 自动提取拍摄信息并生成标签
2. **在线图片编辑**: 支持裁剪、旋转、调色等操作
3. **批量操作**: 高效管理大量图片
4. **响应式设计**: 适配 PC、平板、手机多端

---

## 7. 文档清单

| 文档 | 说明 |
|------|------|
| [设计文档.md](./设计文档.md) | 系统架构、数据库设计、API 设计 |
| [使用手册.md](./使用手册.md) | 用户操作指南 |
| [项目搭建.md](./项目搭建.md) | 环境配置、项目启动指南 |
| [实验报告.md](./实验报告.md) | 功能完成情况、问题解决、总结 |

---

## 8. 总结与收获

### 8.1 技术能力提升

- 掌握了 Vue 3 Composition API 的使用
- 深入理解了 Django REST Framework 的 ViewSet 和 Router 机制
- 学会了 Celery 异步任务处理
- 了解了 AI API 的集成方式
- 掌握了 Docker 容器化部署

### 8.2 工程能力提升

- 学会了规范的项目结构组织
- 理解了前后端分离的开发模式
- 提高了调试和解决问题的能力
- 养成了编写可维护代码的习惯



